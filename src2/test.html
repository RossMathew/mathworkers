<!DOCTYPE HTML>
<html>
  <head>
    <meta charset="utf-8">
  </head>
  <body>
	<script>

var nWorkers = 2;

var pool = []
for (var n = 0; n < nWorkers; n++) {
	pool.push(new Worker("work.js"));
}

setTimeout( function() {

	var workerStart = window.performance.now();

    // Reduce kernel
	var total = 0;
	var nWorkersReported = 0;
	var reduceKernel = function(event) {
		//total += event.data.myDot;
		nWorkersReported += 1;
		if (nWorkersReported == nWorkers) {
			console.log("workers: " + (window.performance.now() - workerStart));
			//console.log("total: " + total);

			// reset?
			//workerStart = window.performance.now();
			//nWorkersReported = 0;
			//total = 0;
		}
	};

	for (var n = 0; n < nWorkers; n++) {
		pool[n].onmessage = reduceKernel;
		pool[n].postMessage({functionId: 1, workerId: n, nWorkers: nWorkers});
	}	

}, 1000);

// serial
setTimeout( function() {
	var serialStart = window.performance.now();

	var vlen = 3000;
	var vec = new Float64Array(vlen);

	for (var i = 0; i < vlen; i++) {
		vec[i] = i * 0.0001;
	}
        var mat = new Float64Array(vlen * vlen);
	//console.log("serial array creation: " + (window.performance.now() - serialStart));
        for (var i = 0; i < vlen; i++) {
            for (var j = 0; j < vlen; j++) {
                mat[i*vlen + j] = 0.0;
            }
            mat[i*vlen + i] = 1.0;
        }

	/*
	var myDot = 0.0;
	for (var nt = 0; nt < 1; nt++) {
	for (var i = 0; i < vlen; i++) {
		myDot += vec[i] * vec[i];
		//for (var j = 0; j < vlen; j++) {
		//	myDot += Math.exp(-(vec[i] * vec[j]));
		//}
	}
	}

	console.log("serial: " + (window.performance.now() - serialStart));
	console.log("total: " + myDot);
	*/

        var resultVector = new Float64Array(vlen);
        for (var i = 0; i < vlen; i++) {
                var tmp = 0.0;
                for (var j = 0; j < vlen; j++) {
                        tmp += mat[i*vlen + j] * vec[j];
                }
                resultVector[i] = tmp;
        }
	console.log("serial: " + (window.performance.now() - serialStart));
	//console.log(resultVector);
}, 2000);

	</script>
  </body>
</html>
